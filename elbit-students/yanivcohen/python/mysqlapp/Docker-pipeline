FROM python:3.12-rc AS builder
WORKDIR /usr/src/app
COPY requirements.txt ./
RUN pip download -r requirements.txt --no-cache-dir 

FROM eeacms/pylint:latest as linting
WORKDIR /code
COPY ./pylint.cfg /etc/pylint.cfg
# COPY --from=builder /usr/src/app/*.py ./
# COPY --from=builder /usr/src/app/api ./api
COPY ./src/*.py /code/
RUN ["echo", "running lint"]

FROM eeacms/pylint:latest as unittest
WORKDIR /code
COPY ./pylint.cfg /etc/pylint.cfg
# COPY --from=builder /usr/src/app/*.py ./
# COPY --from=builder /usr/src/app/api ./api
COPY ./src/*.py /code/
RUN ["echo", "running unit test"]

FROM python:3.12-rc-alpine  AS final
WORKDIR /usr/src/app
COPY --from=builder /usr/src/app/* ./
RUN pip install --no-index --find-links ./ -r requirements.txt && rm -rf *.whl
COPY ./src/main.py .
CMD [ "python", "main.py" ]